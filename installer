#!/bin/bash

# Run this script to download and install the CONCEPT code by Jeppe Dakin
# with all dependencies. If run without an argument, it will prompt for
# an installation directory. This can also be passed as an argument.
# You can also download and run this script via the following command:
# bash <(wget -O- --no-ch tiny.cc/nbody)
# The above uses a URL shortener. If it does not work, use the full URL:
# https://raw.githubusercontent.com/jmd-dk/concept/master/installer

# Set up error trapping
ctrl_c()
{
    trap : 0
    exit 2
}
abort()
{
    printf "\n\e[1m\e[91mAn error occurred during ${current_step}!\e[0m\n" >&2
    exit 1
}
trap 'ctrl_c' SIGINT
trap 'abort' EXIT
set -e

# Creating top level directory
current_step="setup of top level directory"
printf "This is the installation script to CO\e[3mN\e[0mCEPT code by Jeppe Dakin.\n"
if [ -z "${1}" ]; then
    read -p "Where should I install the code?`echo $'\n> '`" -e top_dir
else 
    top_dir="${1}"
fi
top_dir="${top_dir//[ ]/\\ }"        # Places backslashes before spaces. These are needed when expanding tilde, but they will not persist!
eval top_dir="${top_dir}"            # Expand tilde
top_dir=$(readlink -f "${top_dir}")  # Convert to absolute path
echo "The code will be installed in ${top_dir}"
mkdir -p "${top_dir}"
cd "${top_dir}"

# Specify installation directories
concept_dir="${top_dir}/concept"
anaconda_dir="${top_dir}/anaconda"
fftw_dir="${top_dir}/fftw"
gadget_dir="${top_dir}/gadget"
fftw_for_gadget_dir="${gadget_dir}/fftw"
gsl_dir="${top_dir}/gsl"
hdf5_dir="${top_dir}/hdf5"
openmpi_dir="${top_dir}/openmpi"


######################
# Installing CONCEPT #
######################
# Anaconda3 2.1.0 (via Miniconda3 3.7.0)
current_step="installation of Anaconda"
printf "\n\e[1m\e[93mInstalling Anaconda\e[0m\n"
wget -nc -O anaconda.sh --no-check-certificate http://repo.continuum.io/miniconda/Miniconda3-3.7.0-Linux-x86_64.sh
bash anaconda.sh -b -p "${anaconda_dir}"
rm anaconda.sh
# Update Conda
"${anaconda_dir}/bin/conda" update --yes conda
# Create a python variable, storing the path to the newly installed Python interpreter
python_version=`"${anaconda_dir}/bin/python" -c "from sys import version_info as v; print(str(v.major) + '.' + str(v.minor))"`
python="${anaconda_dir}/bin/python${python_version}"

# Cython, Matplotlib, Numpy, Pexpect and Scipy via Conda
current_step="installation of Cython, Matplotlib, NumPy, Pexpect and SciPy"
printf "\n\e[1m\e[93mInstalling Cython, Matplotlib, NumPy, Pexpect and SciPy\e[0m\n"
"${anaconda_dir}/bin/conda" install --yes cython matplotlib numpy pexpect scipy
# Update all packages in Anaconda
"${anaconda_dir}/bin/conda" update --yes --all
# Do some cleanup in the Anaconda distribution
"${anaconda_dir}/bin/conda" clean --yes -i -l -t -p

# GSL (latest stable version)
current_step="installation of GSL"
printf "\n\e[1m\e[93mInstalling GSL\e[0m\n"
mkdir "${gsl_dir}"
mkdir tmp
cd tmp
wget -nc -O gsl.tar.gz --no-check-certificate http://mirrors.dotsrc.org/gnu/gsl/gsl-latest.tar.gz
tar xf gsl.tar.gz
cd gsl*
./configure --prefix="${gsl_dir}"
make
make install
cp COPYING README "${gsl_dir}"
cd ../../
rm -rf tmp

# The cython_gsl Python package (latest version)
current_step="installation of Cython_GSL"
printf "\n\e[1m\e[93mInstalling Cython_GSL\e[0m\n"
wget -nc -O CythonGSL.tar.gz --no-check-certificate https://github.com/twiecki/CythonGSL/archive/master.tar.gz
tar xf CythonGSL.tar.gz
cd CythonGSL*
export LD_LIBRARY_PATH="${gsl_dir}/lib:$LD_LIBRARY_PATH"
"${python}" setup.py build
"${python}" setup.py install
cd ..
rm -rf CythonGSL*

# Open MPI 1.8.3
current_step="installation of Open MPI"
printf "\n\e[1m\e[93mInstalling Open MPI\e[0m\n"
mkdir "${openmpi_dir}"
mkdir tmp
cd tmp
wget -nc -O openmpi.tar.bz2 --no-check-certificate http://www.open-mpi.org/software/ompi/v1.8/downloads/openmpi-1.8.3.tar.bz2
tar xjf openmpi.tar.bz2
cd openmpi*
./configure --prefix="${openmpi_dir}"
make all
make install
cp LICENSE README "${openmpi_dir}"
cd ../../
rm -rf tmp

# The mpi4py 1.3.1 Python package (cannot use conda, as it installs an outdated version)
current_step="installation of MPI4Py"
printf "\n\e[1m\e[93mInstalling MPI4Py\e[0m\n"
wget -nc -O mpi4py.tar.gz --no-check-certificate https://bitbucket.org/mpi4py/mpi4py/downloads/mpi4py-1.3.1.tar.gz
tar xf mpi4py.tar.gz
cd mpi4py*
export LD_LIBRARY_PATH="${openmpi_dir}/lib":"$LD_LIBRARY_PATH"
export MPICC="${openmpi_dir}/bin/mpicc"
"${python}" setup.py install
cd ..
rm -rf mpi4py*

# HDF5 (latest stable version)
current_step="installation of HDF5"
printf "\n\e[1m\e[93mInstalling HDF5\e[0m\n"
mkdir tmp
cd tmp
wget -nc -O hdf5.tar.bz2 --no-check-certificate ftp://ftp.hdfgroup.org/HDF5/current/src/hdf5*tar.bz2
tar xjf hdf5.tar.bz2
cd hdf5*
CC="${openmpi_dir}/bin/mpicc" ./configure --enable-shared --enable-parallel --prefix="${hdf5_dir}"
make
make install
cp COPYING README.txt "${hdf5_dir}"
cd ../../
rm -rf tmp

# The h5py 2.4.0 Python package (cannot use conda, as it does not install the parallel version)
current_step="installation of h5py"
printf "\n\e[1m\e[93mInstalling h5py\e[0m\n"
wget -nc -O h5py.tar.gz --no-check-certificate https://pypi.python.org/packages/source/h/h5py/h5py-2.4.0.tar.gz
tar xf h5py.tar.gz
cd h5py*
export CC="${openmpi_dir}/bin/mpicc"
"${python}" setup.py configure --mpi --hdf5="${hdf5_dir}"
"${python}" setup.py build
"${python}" setup.py install
cd ..
rm -rf h5py*

# FFTW 3.3.4
current_step="installation of FFTW"
printf "\n\e[1m\e[93mInstalling FFTW\e[0m\n"
mkdir tmp
cd tmp
wget -nc -O fftw.tar.gz http://www.fftw.org/fftw-3.3.4.tar.gz
tar xf fftw.tar.gz
cd fftw*
# Double-precision
CC="${openmpi_dir}/bin/mpicc" MPICC="${openmpi_dir}/bin/mpicc" CFLAGS="-O3 -fPIC" CPPFLAGS="-I/${openmpi_dir}/include" LDFLAGS="-L${openmpi_dir}/lib" MPILIBS=-lmpi ./configure --enable-shared --enable-mpi --enable-openmp --enable-threads --prefix="${fftw_dir}"
make
make install
# Single-precision goes here ..........................
cp COPYING README "${fftw_dir}"
cd ../../
rm -rf tmp

# The CONCEPT code
current_step="installation of CO\e[3mN\e[0m\e[1m\e[91mCEPT"
printf "\n\e[1m\e[93mInstalling CO\e[3mN\e[0m\e[1m\e[93mCEPT\e[0m\n"
wget -nc -O concept.tar.gz --no-check-certificate https://github.com/jmd-dk/concept/archive/master.tar.gz
tar xf concept.tar.gz
rm concept.tar.gz
mv concept-master/* "${top_dir}"  # This leaves the .paths file behind in the concept-master folder
rm -r concept-master

# Create the .paths file, storing important paths used by the program
current_step="creataion of the .paths file"
printf "\nWriting paths to .paths\n"
Gadget2_dir="${gadget_dir}/Gadget2"
cython="${anaconda_dir}/bin/cython"
mpicc="${openmpi_dir}/bin/mpicc"
mpiexec="${openmpi_dir}/bin/mpiexec"
python_incl_m="${anaconda_dir}/include/python${python_version}m"
run="${concept_dir}/run"
tests_dir="${concept_dir}/tests"
echo "# This file contains absolute paths to directories and files used by the
# program. You must manually edit the paths below. All other files rely on
# these paths, as they are not given anywhere else.

###############
# Directories #
###############
# Directory containing the GADGET2 source code
Gadget2_dir='${Gadget2_dir}'
# Directory containing the CONCEPT source code
concept_dir='${concept_dir}'
# Directory of the Anaconda Python distribution
anaconda_dir='${anaconda_dir}'
# Directory of FFTW
fftw_dir='${fftw_dir}'
# Directory of FFTW2, used by GADGET
fftw_for_gadget_dir='${fftw_for_gadget_dir}'
# Directory of Gadget2
gadget_dir='${gadget_dir}'
# Directory of GSL
gsl_dir='${gsl_dir}'
# Directory of HDF5
hdf5_dir='${hdf5_dir}'
# Directory of MPI
openmpi_dir='${openmpi_dir}'
# Directory containing tests for the CONCEPT code
tests_dir='${tests_dir}'
# Top level directory, containing e.g. README.md
top_dir='${top_dir}'

#########
# Files #
#########
# The Python3 interpreter
python='${python}'
# The python3.xm file within the include directory of Anaconda
python_incl_m='${python_incl_m}'
# The Cython executable
cython='${cython}'
# The MPI C compiler
mpicc='${mpicc}'
# The MPI executable
mpiexec='${mpiexec}'
# The run script of the CONCEPT code
run='${run}'
" > "${top_dir}/.paths"


######################################################
# Install GADGET2, used for testing the CONCEPT code #
######################################################
# FFTW 2.1.5 (GADGET2 is incompatible with FFTW 3.x)
current_step="installation of FFTW2 used by GADGET"
printf "\n\e[1m\e[93mInstalling FFTW2, used by GADGET\e[0m\n"
mkdir tmp
cd tmp
wget -nc -O fftw.tar.gz http://www.fftw.org/fftw-2.1.5.tar.gz
tar xf fftw.tar.gz
cd fftw*
# Double-precision
CC="${openmpi_dir}/bin/mpicc" MPICC="${openmpi_dir}/bin/mpicc" CFLAGS="-O3 -fPIC" CPPFLAGS="-I${openmpi_dir}/include" LDFLAGS="-L${openmpi_dir}/lib" MPILIBS=-lmpi ./configure --enable-shared --enable-mpi --enable-openmp --enable-threads --enable-type-prefix --prefix="${fftw_for_gadget_dir}"
make
make install
# Single-precision
make clean
CC="${openmpi_dir}/bin/mpicc" MPICC="${openmpi_dir}/bin/mpicc" CFLAGS="-O3 -fPIC" CPPFLAGS="-I${openmpi_dir}/include" LDFLAGS="-L${openmpi_dir}/lib" MPILIBS=-lmpi ./configure --enable-shared --enable-mpi --enable-openmp --enable-threads --enable-float --enable-type-prefix --prefix="${fftw_for_gadget_dir}"
make
make install
cp COPYING README "${fftw_for_gadget_dir}"
cd ../../
rm -rf tmp

# GADGET2
current_step="installation of GADGET"
printf "\n\e[1m\e[93mInstalling GADGET\e[0m\n"
mkdir tmp
cd tmp
wget -nc -O gadget2.tar.gz http://www.mpa-garching.mpg.de/gadget/gadget-2.0.7.tar.gz
tar xf gadget2.tar.gz
mv Gadget*/* "${gadget_dir}"
cd ..
rm -rf tmp

# Copyright notice
current_step="copyright notice"
printf "\n\e[1m\e[93mCopyright notice\e[0m
Anaconda, GSL, Open MPI, HDF5, FFTW and GADGET (along with its own
version of FFTW) has been installed into seperate folders in ${top_dir}.
Any use of CO\e[3mN\e[0mCEPT must conform to the license terms of the
above software. These can be found in their seperate installation
directories.\n"

# Installation complete. Deactivate trap before exiting.
trap : 0
printf "\n\e[1m\e[92mCO\e[3mN\e[0m\e[1m\e[92mCEPT successfully installed\e[0m\n"

