#!/bin/bash



# The name of this test (the directory name)
this_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Set up error trapping
ctrl_c()
{
    trap : 0
    exit 2
}
abort()
{
    printf "\e[1m\e[91mAn error occurred during random IC generation!\e[0m\n" >&2
    exit 1
}
trap 'ctrl_c' SIGINT
trap 'abort' EXIT
set -e

# Argument check
if [ "$#" -gt 2 ]; then
    echo "Too many arguments supplied."
    exit 1
elif [ "$#" -lt 2 ]; then
    echo "You must pass in a parameter file as the first argument and the number of particles as the second."
    exit 1
fi
params="${1}"
params="${params//[ ]/\\ }"        # Places backslashes before spaces. These are needed when expanding tilde, but they will not persist!
eval path="${params}"            # Expand tilde
params=$(readlink -f "${params}")  # Convert to absolute path
N="${2}"

# Load paths from the .paths file
curr="${this_dir}"
while [ 1 ]; do
    if [ -f "${curr}/.paths" ]; then
        source "${curr}/.paths"
        break
    fi
    if [ "${curr}" == "/" ]; then
        printf "\e[1m\e[91mCould not find the .paths file!\e[0m\n" >&2
        exit 1
    fi
    curr="`dirname \"${curr}\"`"
done

# Make temporary Python file
printf "
# Include the code directory in the searched paths
import sys, os
concept_dir = os.path.realpath(__file__)
this_dir = os.path.dirname(concept_dir)
while True:
    if concept_dir == '/':
        raise Exception('Cannot find the .paths file!')
    if '.paths' in os.listdir(os.path.dirname(concept_dir)):
        break
    concept_dir = os.path.dirname(concept_dir)
sys.path.append(concept_dir)

# Imports from the CONCEPT code
from commons import *
from species import construct_random
from IO import save

# Do not continue if the IC_file already exists
if os.path.isfile(IC_file):
    print('The file', IC_file, 'already exists. Aborting.')
    sys.exit(1)

# Construct random particles
particles = construct_random('generated by generate_random_ICs', 'dark matter', ${N})

# Save particles
save(particles, a_begin, IC_file)
" > "${this_dir}/generate_random_ICs.py"

# Run the CONCEPT code with the newly generated Python file as the
# main entry point to generate the ICs.
"${run}" -n 1 -p "${params}" -m "${this_dir}/generate_random_ICs.py" --local --pure-python

# Plot complete. Deactivate trap before exiting
trap : 0

